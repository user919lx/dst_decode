# 系统组件

系统底层组件，是被封装好的，无法看到底层的定义代码，只能根据官方代码来猜测用法。之所以做这样的封装，往往是因为相关的功能需要调用非常底层的API或者需要高速运算节约性能。它们被广泛地应用，在任何代码里都有可能见到。本文会介绍常用的系统组件以及其中常用的函数。


## AnimState

这个组件主要负责对角色的外观和动画进行控制。人物执行不同的动作会播放不同的动画，佩戴某些装备会改变外观，以及改变视觉上的大小，甚至计量条的变化等。凡是和物体形态变化有关的，都由AnimState来操作实现。


| fn                        | 用途说明                                                                         | 传入参数说明（按参数顺序）                                                                                                                | 返回值说明                       |
|---------------------------|------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|-----------------------------|
| PlayAnimation             | 播放指定名称的动画，会立刻中断当前动画的播放                                                       | anim 动画名; loop 是否重复，可省略，默认值是fasle                                                                                            | 无                           |
| PushAnimation             | 将指定动画推送到播放序列中，当前动画播放完后会接着播放这个动画，常见于要通过一组动画来表现人物的场景                           | anim 动画名; loop 是否重复，可省略，默认值是fasle                                                                                            | 无                           |
| SetBuild                  | 设置指定的外观。比如兔子有夏、冬两种形态，就是通过设置不同的Build来实现的                                      | build 外观名                                                                                                                    | 无                           |
| SetBank                   | 设置指定的动画组。玩家站在地上和骑在牛上，使用的是两套不同的动画，就是通过设置不同的Bank来实现的                           | bank 动画组名                                                                                                                    | 无                           |
| Show                      | 展示某个部分，通常和Hide搭配使用。比如，装备武器时，会隐藏ARM_normal，显示ARM_carry，人物的手就发生了变化             | part 部分                                                                                                                      | 无                           |
| Hide                      | 隐藏某个部分，和Show搭配使用                                                             | part 部分                                                                                                                      | 无                           |
| OverrideSymbol            | 覆盖某个标记点，常见于装备武器后，手上就出现了一把武器。                                                 | inst_symbol 要覆盖的标记点 ;swap_build 用于替换的build ;swap_symbol 用于替换的build上的标记点                                                      | 无                           |
| ClearOverrideSymbol       | 清除指定标记点的覆盖                                                                   | inst_symbol 要清除覆盖的标记点                                                                                                        | 无                           |
| IsCurrentAnimation        | 检测当前播放的动画是否为指定的动画                                                            | anim 动画名                                                                                                                     | 无                           |
| SetTime                   | 设置动画停留在第几秒                                                                   | time 停留位置                                                                                                                    | 无                           |
| GetCurrentAnimationTime   | 获取当前动画停留在第几秒                                                                 | 无                                                                                                                            | time 停留位置                   |
| GetCurrentAnimationLength | 获取当前动画的长度                                                                    | 无                                                                                                                            | length 动画长度                 |
| SetPercent                | 设置动画百分比，对于一些通过动画帧来表现数值的物品很有用。比如雨量计，实际上是设置了一个动画，从0到100%，然后根据实际数值设置相应的百分比      | anim 动画名; percent 百分比                                                                                                        | 无                           |
| SetFinalOffset            | 不确定，根据函数名猜测，是设置动画的帧偏移量。                                                      | offset 动画偏移量，可以设置为负数。                                                                                                        | 无                           |
| SetScale                  | 设置缩放比例                                                                       | length_scale 长度缩放;width_scale 宽度缩放 。取值填小数，如果是负数，则是相应的方向颠倒。                                                                   | 无                           |
| SetMultColour             | 设置角色的r,g,b,a，也就是三个颜色+透明度。可以通过这个函数来让角色变得透明                                    | r,g,b,a四个参数，分别对应红，绿，蓝的颜色值以及透明度。取值均在[0,1]之间。对于透明度，取0时就是完全透明。                                                                  | 无                           |
| GetMultColour             | 获取角色的r,g,b,a                                                                 | 无                                                                                                                            | r,g,b,a 同SetMultColour的输入参数 |
| SetAddColour              | 设置附加颜色                                                                       | r,g,b,a四个参数，分别对应红，绿，蓝的颜色值以及透明度。取值均在[0,1]之间。对于透明度，取0时就是完全透明。                                                                  | 无                           |
| SetBloomEffectHandle      | 设置Bloom效果的处理器                                                                | path 处理器路径                                                                                                                   | 无                           |
| SetOrientation            | 设置刚体轴方向。不同的轴方向会影响看到的视觉效果，比如池塘看起来是贴着地面的，就是因为设置了这一参数为ANIM_ORIENTATION.OnGround | direction 方向，这里使用定义于constants.lua中的全局变量，ANIM_ORIENTATION下的各个值                                                                | 无                           |
| SetLayer                  | 设置图层，图层是有固定的摆放顺序的，比如土地是最下一层，然后农场是中间层，农场里的作物是最上层。在构建一些多层结构的东西时，都需要设置图层。       | layer 图层变量，这里使用定义于constants.lua中的全局变量，LAYER_BACKGROUND/LAYER_WORLD/LAYER_WORLD_BACKGROUND/LAYER_WORLD_CEILING/LAYER_FRONTEND | 无                           |
| SetSortOrder              | 设置排序优先级，常与SetLayer配套使用，当有多个物品重叠时，优先级高的排在前面。                                  | priority 优先级，整数                                                                                                              | 无                           |

## SoundEmitter

声音控制组件，用于播放物体本身拥有的音效资源。


| fn                  | 用途说明                  | 传入参数说明（按参数顺序）                                         | 返回值说明                               |
|---------------------|-----------------------|-------------------------------------------------------|-------------------------------------|
| PlaySound           | 播放指定音效                | path 音效文件路径                                           | 无                                   |
| KillSound           | 停止播放指定音效              | sound 音效名                                             | 无                                   |
| PlayingSound        | 判断是否在播放指定音效           | sound 音效名                                             | is_playing 是否在播放该音效，取值为true 或 false |
| SetParameter        | 设置音效参数，可能会影响某些音效的播放效果 | sound 音效名;param 参数名;value 参数值                         | 无                                   |
| SetVolume           | 设置音量                  | sound 音效名;volume 音量                                   | 无                                   |
| PlaySoundWithParams | 带着参数播放音效              | path 音效文件路径,param_tbl 参数表，形如{param_a=xxx,param_b=xxx} | 无                                   |


## Transform

这一组件负责管理物体的位置、大小、方向等。其中「大小」与AnimState有区别的地方在于，AnimState设置的大小是视觉上的大小，而Transform则是实际上的大小，会影响到物体的碰撞等相关物理效果。

| fn               | 用途说明                                                                                                           | 传入参数说明（按参数顺序）                            | 返回值说明                   |
|------------------|----------------------------------------------------------------------------------------------------------------|------------------------------------------|-------------------------|
| SetPosition      | 设置物体的世界坐标，可以让物体瞬移到指定位置                                                                                         | x,y,z 物体的三维坐标                            | 无                       |
| GetWorldPosition | 获取物体的当前世界坐标                                                                                                    | 无                                        | x,y,z 物体的三维坐标           |
| SetScale         | 设置物体的缩放比例                                                                                                      | x,y,z 物体在三个方向上的缩放比例                      | 无                       |
| GetScale         | 获取物体的缩放比例                                                                                                      | 无                                        | x,y,z 物体在三个方向上的缩放比例     |
| SetFromProxy     | 不确定，猜测是设置所有参数同步于proxy，一般常见于各种特效，同步于对应的附加物上                                                                     | proxy_guid 常用的写法是传入proxy变量，然后取proxy.GUID | 无                       |
| SetRotation      | 设置物体的朝向                                                                                                        | degree 朝向角度，取值范围[0,360]                  | 无                       |
| GetRotation      | 获取物体的朝向                                                                                                        | 无                                        | degree 朝向角度，取值范围[0,360] |
| SetFourFaced     | 设置物体有四个面，会影响物体在相应朝向时展示的形态。四个面就是每个面占90度。其它类似的还有SetNoFaced(1面),SetTwoFaced(2面),SetSixFaced(6面),SetEightFaced(8面) | 无                                        | 无                       |

## Physics

这一组件负责管理物体的物理运动相关的内容，包括物理参数，移动，碰撞等。
通常而言，不建议自己配置物理运动相关的参数，错误参数可能造成一些诡异的物理效果。最好使用官方给出的预设函数来一键配置，位于`standardcomponents`

RemovePhysicsColliders
**相关函数待定，需要测试，结合设置各种物理配置的脚本来查看**
MakeCharacterPhysics 等



## MiniMapEntity
这一组件负责管理小地图的图标


| fn                  | 用途说明               | 传入参数说明（按参数顺序）     | 返回值说明 |
|---------------------|--------------------|-------------------|-------|
| SetIcon             | 设置小地图图标            | image 图标文件名       | 无     |
| SetPriority         | 设置优先级，高优先级可以显示在更上面 | priority 优先级，整数   | 无     |
| SetEnabled          | 设置小地图图标是否可用        | 是否可用,取值ture/false | 无     |
| SetCanUseCache      | 待定，设置可使用缓存         | 是否可用,取值ture/false | 无     |
| SetDrawOverFogOfWar | 待定，设置可无视迷雾显示图标     | 是否可用,取值ture/false | 无     |
| SetIsFogRevealer    | 待定，设置可以显示迷雾        | 是否可用,取值ture/false | 无     |

## DynamicShadow

这一组件负责管理物体的影子。每个物体的影子都各不相同，甚至同一个角色，在不同的装备下也有不同的效果。大家可以试试装备不同的雨伞观察一下影子的变化。

| fn      | 用途说明    | 传入参数说明（按参数顺序）                              | 返回值说明 |
|---------|---------|--------------------------------------------|-------|
| SetSize | 设置影子大小  | length_scale 长度缩放;width_scale 宽度缩放 。取值填小数。 | 无     |
| Enable  | 设置是否有影子 | 取值 ture/false                              | 无     |

## Light

这一组件负责管理光源，可以为一个物体添加光源并调整设置相关参数如发光半径、强度、衰减度等。

| fn                     | 用途说明                                                     | 传入参数说明（按参数顺序）              | 返回值说明                      |
|------------------------|----------------------------------------------------------|----------------------------|----------------------------|
| Enable                 | 设置光源是否可用                                                 | 取值 ture/false              | 无                          |
| IsEnabled              | 判断光源是否可用                                                 | 无                          | 取值 ture/false              |
| SetRadius              | 设置光源半径。在很多涉及光的计算中都会用到光源半径，比如作物生长需要光源，这个光源是有距离要求的，太远的就不算。 | radius 半径距离                | 无                          |
| GetCalculatedRadius    | 获取光源半径                                                   | 无                          | radius 半径距离                |
| SetIntensity           | 设置光源亮度                                                   | intensity 亮度,取值[0,1]       | 无                          |
| SetFalloff             | 设置衰减强度                                                   | falloff 衰减强度,取值[0,1]       | 无                          |
| SetColour              | 设置光源颜色                                                   | r,g,b 分别对应红，绿，蓝的颜色，取值[0,1] | 无                          |
| GetColour              | 获取光源颜色                                                   | 无                          | r,g,b 分别对应红，绿，蓝的颜色，取值[0,1] |
| EnableClientModulation | 待定，未确认用途                                                 |                            |                            |

## LightWatcher

光照监视器，这一组件可以监控光照的情况。在游戏中，很多动植物的活动都和光照有关。例如蜘蛛一般情况下只在晚上和黑暗环境下活动，猪人则在白天或者明亮的环境下活动。如何判断黑暗和明亮，就是光照监视器来做的。

| fn             | 用途说明      | 传入参数说明（按参数顺序）     | 返回值说明         |
|----------------|-----------|-------------------|---------------|
| IsInLight      | 判断是否在明亮环境 | 无                 | 取值 ture/false |
| SetLightThresh | 设置明亮阈值    | thresh 阈值，取值[0,1] | 无             |
| SetDarkThresh  | 设置黑暗阈值    | thresh 阈值，取值[0,1] | 无             |
| GetTimeInLight | 获取光照时长    | 无                 | time 光照时长     |
| GetLightAngle  | 获取光照角度    | 无                 | angle 光照角度    |
| GetLightValue  | 获取光照值     | 无                 | light_val 光照值 |


## Follower

在component中也有一个同名的follower，但这个系统组件的follower是更底层的，常用于一些特效跟随的处理。而component的follower更侧重于一个生物跟随另一个生物。

| fn           | 用途说明               | 传入参数说明（按参数顺序）                                         | 返回值说明 |
|--------------|--------------------|-------------------------------------------------------|-------|
| FollowSymbol | 跟随标记，常用于特效跟随于某个物体。 | target_guid 跟随目标的guid;symbol 跟随的标记点; x,y,z 在三个方向上的偏移量 | 无     |

## Network
网络相关，未能根据代码直接看出用途，需要在游戏中进行较多的实验才能确定，暂时略过。



